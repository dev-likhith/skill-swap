import React, { useState } from "react";
import { base44 } from "@/api/base44Client";
import { useMutation, useQueryClient } from "@tanstack/react-query";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Sparkles, Loader2 } from "lucide-react";
import { Alert, AlertDescription } from "@/components/ui/alert";

export default function AISummaryCard({ purchase }) {
  const queryClient = useQueryClient();
  const [isGenerating, setIsGenerating] = useState(false);

  const generateSummary = useMutation({
    mutationFn: async () => {
      setIsGenerating(true);
      
      const summary = await base44.integrations.Core.InvokeLLM({
        prompt: `Generate a comprehensive learning summary for a course titled "${purchase.video_title}". 
        
        Create a detailed summary that includes:
        1. **Overview**: What this course is about in 2-3 sentences
        2. **Key Topics**: List 4-5 main topics covered
        3. **Learning Outcomes**: What students will be able to do after completing this course (3-4 bullet points)
        4. **Best Practices**: 2-3 practical tips for applying what's learned
        5. **Next Steps**: Suggest what students should study next to build on this knowledge
        
        Make it engaging, actionable, and student-focused. Use clear formatting with markdown.`,
      });

      await base44.entities.Purchase.update(purchase.id, {
        ai_summary: summary
      });

      return summary;
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['myPurchases'] });
      setIsGenerating(false);
    },
    onError: (error) => {
      console.error('Error generating summary:', error);
      setIsGenerating(false);
    },
  });

  return (
    <Card className="border-purple-200 shadow-lg">
      <CardHeader className="bg-gradient-to-r from-purple-50 to-pink-50">
        <CardTitle className="flex items-center gap-2 text-lg">
          <Sparkles className="w-5 h-5 text-purple-500" />
          AI-Generated Summary
        </CardTitle>
      </CardHeader>
      <CardContent className="pt-6">
        {!purchase.ai_summary && !isGenerating && (
          <div className="text-center py-8">
            <p className="text-gray-600 mb-4">Generate an AI-powered summary of this course</p>
            <Button
              onClick={() => generateSummary.mutate()}
              className="bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600"
            >
              <Sparkles className="w-4 h-4 mr-2" />
              Generate Summary
            </Button>
          </div>
        )}

        {isGenerating && (
          <div className="flex flex-col items-center justify-center py-12">
            <Loader2 className="w-12 h-12 text-purple-500 animate-spin mb-4" />
            <p className="text-gray-600">AI is analyzing the course content...</p>
            <p className="text-sm text-gray-500 mt-2">This may take 10-15 seconds</p>
          </div>
        )}

        {purchase.ai_summary && !isGenerating && (
          <div className="prose prose-sm max-w-none">
            <Alert className="bg-purple-50 border-purple-200 mb-4">
              <Sparkles className="w-4 h-4 text-purple-500" />
              <AlertDescription className="text-purple-700">
                This summary was automatically generated by AI to help you review key concepts
              </AlertDescription>
            </Alert>
            <div className="whitespace-pre-wrap text-gray-700 leading-relaxed">
              {purchase.ai_summary}
            </div>
            <Button
              variant="outline"
              onClick={() => generateSummary.mutate()}
              className="mt-4 w-full"
              disabled={isGenerating}
            >
              <Sparkles className="w-4 h-4 mr-2" />
              Regenerate Summary
            </Button>
          </div>
        )}
      </CardContent>
    </Card>
  );
}