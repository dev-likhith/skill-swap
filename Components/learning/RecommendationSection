import React, { useState } from "react";
import { base44 } from "@/api/base44Client";
import { useQuery, useMutation } from "@tanstack/react-query";
import { Link } from "react-router-dom";
import { createPageUrl } from "@/utils";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Sparkles, Loader2, TrendingUp, ExternalLink } from "lucide-react";
import { Badge } from "@/components/ui/badge";
import { Skeleton } from "@/components/ui/skeleton";

export default function RecommendationsSection({ userId }) {
  const [recommendations, setRecommendations] = useState(null);
  const [isGenerating, setIsGenerating] = useState(false);

  const { data: user } = useQuery({
    queryKey: ['currentUser'],
    queryFn: () => base44.auth.me(),
  });

  const { data: purchases } = useQuery({
    queryKey: ['myPurchases', userId],
    queryFn: () => base44.entities.Purchase.filter({ learner_id: userId }, '-created_date'),
    initialData: [],
    enabled: !!userId,
  });

  const { data: allVideos } = useQuery({
    queryKey: ['videos'],
    queryFn: () => base44.entities.Video.filter({ status: 'published' }),
    initialData: [],
  });

  const generateRecommendations = useMutation({
    mutationFn: async () => {
      setIsGenerating(true);

      // Get user's viewing history
      const purchasedVideoIds = purchases.map(p => p.video_id);
      const purchasedTitles = purchases.map(p => p.video_title).join(', ');
      const viewingHistory = user?.viewing_history || [];

      // Get AI recommendations
      const recommendationData = await base44.integrations.Core.InvokeLLM({
        prompt: `Based on a learner's course history, recommend 3 relevant courses they should take next.
        
        Courses they've already taken: ${purchasedTitles || 'None yet'}
        Categories they've explored: ${viewingHistory.join(', ') || 'None yet'}
        
        Available courses: ${allVideos.map(v => `"${v.title}" (${v.category})`).join(', ')}
        
        Recommend 3 courses that:
        1. Build on their existing knowledge
        2. Fill knowledge gaps
        3. Are in related but new areas
        
        Return ONLY valid JSON (no markdown):
        {
          "recommendations": [
            {
              "video_id": "actual video id from available courses",
              "title": "course title",
              "reason": "why this is recommended (1-2 sentences)"
            }
          ]
        }`,
        response_json_schema: {
          type: "object",
          properties: {
            recommendations: {
              type: "array",
              items: {
                type: "object",
                properties: {
                  video_id: { type: "string" },
                  title: { type: "string" },
                  reason: { type: "string" }
                }
              }
            }
          }
        }
      });

      // Match recommendations with actual videos
      const enrichedRecommendations = recommendationData.recommendations
        .map(rec => {
          const video = allVideos.find(v => 
            v.id === rec.video_id || 
            v.title.toLowerCase().includes(rec.title.toLowerCase())
          );
          return video ? { ...rec, video } : null;
        })
        .filter(Boolean)
        .slice(0, 3);

      setRecommendations(enrichedRecommendations);
      setIsGenerating(false);
      
      return enrichedRecommendations;
    },
    onError: (error) => {
      console.error('Error generating recommendations:', error);
      setIsGenerating(false);
    },
  });

  return (
    <Card className="border-indigo-200 shadow-md">
      <CardHeader className="bg-gradient-to-r from-indigo-50 to-purple-50">
        <CardTitle className="flex items-center gap-2 text-lg">
          <TrendingUp className="w-5 h-5 text-indigo-500" />
          AI Recommendations
        </CardTitle>
      </CardHeader>
      <CardContent className="pt-6">
        {!recommendations && !isGenerating && (
          <div className="text-center py-6">
            <Sparkles className="w-12 h-12 text-indigo-300 mx-auto mb-3" />
            <p className="text-sm text-gray-600 mb-4">Get personalized course recommendations</p>
            <Button
              onClick={() => generateRecommendations.mutate()}
              size="sm"
              className="bg-gradient-to-r from-indigo-500 to-purple-500"
            >
              <Sparkles className="w-4 h-4 mr-2" />
              Get Recommendations
            </Button>
          </div>
        )}

        {isGenerating && (
          <div className="flex flex-col items-center justify-center py-8">
            <Loader2 className="w-10 h-10 text-indigo-500 animate-spin mb-3" />
            <p className="text-sm text-gray-600">Analyzing your learning path...</p>
          </div>
        )}

        {recommendations && recommendations.length > 0 && (
          <div className="space-y-3">
            {recommendations.map((rec, idx) => (
              <div key={idx} className="p-3 bg-gradient-to-r from-indigo-50 to-purple-50 rounded-lg border border-indigo-100">
                <div className="flex items-start justify-between mb-2">
                  <h4 className="font-semibold text-sm line-clamp-1">{rec.video?.title || rec.title}</h4>
                  <Link to={`${createPageUrl("VideoDetails")}?id=${rec.video?.id}`}>
                    <Button variant="ghost" size="icon" className="h-6 w-6">
                      <ExternalLink className="w-3 h-3" />
                    </Button>
                  </Link>
                </div>
                <p className="text-xs text-gray-600 mb-2">{rec.reason}</p>
                {rec.video && (
                  <div className="flex items-center gap-2">
                    <Badge variant="outline" className="text-xs">
                      {rec.video.base_credits} credits
                    </Badge>
                    <Badge variant="secondary" className="text-xs">
                      {rec.video.category.replace(/_/g, ' ')}
                    </Badge>
                  </div>
                )}
              </div>
            ))}
            <Button
              onClick={() => generateRecommendations.mutate()}
              variant="outline"
              size="sm"
              className="w-full"
            >
              <Sparkles className="w-3 h-3 mr-2" />
              Refresh Recommendations
            </Button>
          </div>
        )}

        {recommendations && recommendations.length === 0 && (
          <p className="text-center text-sm text-gray-500 py-4">
            No recommendations available at the moment
          </p>
        )}
      </CardContent>
    </Card>
  );
}