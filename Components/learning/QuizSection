import React, { useState } from "react";
import { base44 } from "@/api/base44Client";
import { useMutation, useQuery, useQueryClient } from "@tanstack/react-query";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Brain, Loader2, CheckCircle, XCircle, Award, RotateCcw } from "lucide-react";
import { Badge } from "@/components/ui/badge";
import { Progress } from "@/components/ui/progress";

export default function QuizSection({ purchase }) {
  const queryClient = useQueryClient();
  const [currentQuestion, setCurrentQuestion] = useState(0);
  const [selectedAnswer, setSelectedAnswer] = useState(null);
  const [showResult, setShowResult] = useState(false);
  const [userAnswers, setUserAnswers] = useState([]);
  const [quizCompleted, setQuizCompleted] = useState(false);
  const [isGenerating, setIsGenerating] = useState(false);

  const { data: existingQuiz } = useQuery({
    queryKey: ['quiz', purchase.id],
    queryFn: async () => {
      const quizzes = await base44.entities.Quiz.filter({ purchase_id: purchase.id });
      return quizzes[0] || null;
    },
  });

  const generateQuiz = useMutation({
    mutationFn: async () => {
      setIsGenerating(true);
      
      const quizData = await base44.integrations.Core.InvokeLLM({
        prompt: `Generate a 5-question multiple choice quiz for a course titled "${purchase.video_title}".
        
        Create questions that test understanding of key concepts. Each question should have:
        - 4 answer options
        - Only one correct answer
        - A brief explanation of why the answer is correct
        
        Return ONLY valid JSON in this exact format (no markdown, no code blocks):
        {
          "questions": [
            {
              "question": "Question text here?",
              "options": ["Option A", "Option B", "Option C", "Option D"],
              "correct_answer": 0,
              "explanation": "Explanation of correct answer"
            }
          ]
        }`,
        response_json_schema: {
          type: "object",
          properties: {
            questions: {
              type: "array",
              items: {
                type: "object",
                properties: {
                  question: { type: "string" },
                  options: { type: "array", items: { type: "string" } },
                  correct_answer: { type: "number" },
                  explanation: { type: "string" }
                }
              }
            }
          }
        }
      });

      const quiz = await base44.entities.Quiz.create({
        video_id: purchase.video_id,
        purchase_id: purchase.id,
        learner_id: purchase.learner_id,
        questions: quizData.questions,
        total_questions: quizData.questions.length,
      });

      return quiz;
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['quiz'] });
      setIsGenerating(false);
      setCurrentQuestion(0);
      setUserAnswers([]);
      setQuizCompleted(false);
    },
    onError: (error) => {
      console.error('Error generating quiz:', error);
      setIsGenerating(false);
    },
  });

  const handleAnswerSelect = (answerIndex) => {
    setSelectedAnswer(answerIndex);
    setShowResult(true);
    
    const newAnswers = [...userAnswers];
    newAnswers[currentQuestion] = answerIndex;
    setUserAnswers(newAnswers);
  };

  const handleNextQuestion = () => {
    if (currentQuestion < existingQuiz.questions.length - 1) {
      setCurrentQuestion(currentQuestion + 1);
      setSelectedAnswer(null);
      setShowResult(false);
    } else {
      completeQuiz();
    }
  };

  const completeQuiz = async () => {
    const correctAnswers = userAnswers.filter((answer, idx) => 
      answer === existingQuiz.questions[idx].correct_answer
    ).length;
    
    const score = Math.round((correctAnswers / existingQuiz.questions.length) * 100);
    
    await base44.entities.Quiz.update(existingQuiz.id, {
      score,
      completed_at: new Date().toISOString(),
    });

    await base44.entities.Purchase.update(purchase.id, {
      quiz_completed: true,
      quiz_score: score,
    });

    setQuizCompleted(true);
    queryClient.invalidateQueries({ queryKey: ['myPurchases'] });
  };

  const resetQuiz = () => {
    setCurrentQuestion(0);
    setSelectedAnswer(null);
    setShowResult(false);
    setUserAnswers([]);
    setQuizCompleted(false);
  };

  if (!existingQuiz && !isGenerating) {
    return (
      <Card className="border-blue-200 shadow-lg">
        <CardHeader className="bg-gradient-to-r from-blue-50 to-cyan-50">
          <CardTitle className="flex items-center gap-2 text-lg">
            <Brain className="w-5 h-5 text-blue-500" />
            AI-Generated Quiz
          </CardTitle>
        </CardHeader>
        <CardContent className="pt-6">
          <div className="text-center py-8">
            <Brain className="w-16 h-16 text-blue-300 mx-auto mb-4" />
            <p className="text-gray-600 mb-4">Test your knowledge with an AI-generated quiz</p>
            <Button
              onClick={() => generateQuiz.mutate()}
              className="bg-gradient-to-r from-blue-500 to-cyan-500 hover:from-blue-600 hover:to-cyan-600"
            >
              <Brain className="w-4 h-4 mr-2" />
              Generate Quiz
            </Button>
          </div>
        </CardContent>
      </Card>
    );
  }

  if (isGenerating) {
    return (
      <Card className="border-blue-200 shadow-lg">
        <CardHeader className="bg-gradient-to-r from-blue-50 to-cyan-50">
          <CardTitle className="flex items-center gap-2 text-lg">
            <Brain className="w-5 h-5 text-blue-500" />
            AI-Generated Quiz
          </CardTitle>
        </CardHeader>
        <CardContent className="pt-6">
          <div className="flex flex-col items-center justify-center py-12">
            <Loader2 className="w-12 h-12 text-blue-500 animate-spin mb-4" />
            <p className="text-gray-600">Creating personalized quiz questions...</p>
            <p className="text-sm text-gray-500 mt-2">This may take 15-20 seconds</p>
          </div>
        </CardContent>
      </Card>
    );
  }

  if (quizCompleted) {
    const correctAnswers = userAnswers.filter((answer, idx) => 
      answer === existingQuiz.questions[idx].correct_answer
    ).length;
    const score = Math.round((correctAnswers / existingQuiz.questions.length) * 100);
    const passed = score >= 70;

    return (
      <Card className="border-blue-200 shadow-lg">
        <CardHeader className="bg-gradient-to-r from-blue-50 to-cyan-50">
          <CardTitle className="flex items-center gap-2 text-lg">
            <Award className="w-5 h-5 text-blue-500" />
            Quiz Completed!
          </CardTitle>
        </CardHeader>
        <CardContent className="pt-6">
          <div className="text-center py-8">
            {passed ? (
              <CheckCircle className="w-20 h-20 text-green-500 mx-auto mb-4" />
            ) : (
              <XCircle className="w-20 h-20 text-orange-500 mx-auto mb-4" />
            )}
            <div className="text-5xl font-bold text-gray-900 mb-2">{score}%</div>
            <p className="text-lg text-gray-600 mb-6">
              You got {correctAnswers} out of {existingQuiz.questions.length} questions correct
            </p>
            {passed ? (
              <Badge className="bg-green-100 text-green-700 text-lg px-6 py-2">
                <CheckCircle className="w-4 h-4 mr-2" />
                Passed!
              </Badge>
            ) : (
              <Badge className="bg-orange-100 text-orange-700 text-lg px-6 py-2">
                Try again to pass (70% required)
              </Badge>
            )}
            <div className="mt-6">
              <Button
                onClick={resetQuiz}
                variant="outline"
                className="mr-3"
              >
                <RotateCcw className="w-4 h-4 mr-2" />
                Retake Quiz
              </Button>
              <Button
                onClick={() => generateQuiz.mutate()}
                className="bg-gradient-to-r from-blue-500 to-cyan-500"
              >
                <Brain className="w-4 h-4 mr-2" />
                New Quiz
              </Button>
            </div>
          </div>
        </CardContent>
      </Card>
    );
  }

  const question = existingQuiz.questions[currentQuestion];
  const isCorrect = selectedAnswer === question.correct_answer;

  return (
    <Card className="border-blue-200 shadow-lg">
      <CardHeader className="bg-gradient-to-r from-blue-50 to-cyan-50">
        <div className="flex items-center justify-between">
          <CardTitle className="flex items-center gap-2 text-lg">
            <Brain className="w-5 h-5 text-blue-500" />
            Question {currentQuestion + 1} of {existingQuiz.questions.length}
          </CardTitle>
          <Badge variant="outline">
            {Math.round(((currentQuestion + 1) / existingQuiz.questions.length) * 100)}%
          </Badge>
        </div>
        <Progress value={((currentQuestion + 1) / existingQuiz.questions.length) * 100} className="mt-3" />
      </CardHeader>
      <CardContent className="pt-6">
        <h3 className="text-xl font-semibold text-gray-900 mb-6">{question.question}</h3>
        
        <div className="space-y-3 mb-6">
          {question.options.map((option, idx) => {
            const isSelected = selectedAnswer === idx;
            const isCorrectOption = idx === question.correct_answer;
            
            let buttonClass = "w-full text-left p-4 rounded-lg border-2 transition-all ";
            if (!showResult) {
              buttonClass += "border-gray-200 hover:border-blue-300 hover:bg-blue-50";
            } else if (isSelected && isCorrect) {
              buttonClass += "border-green-500 bg-green-50";
            } else if (isSelected && !isCorrect) {
              buttonClass += "border-red-500 bg-red-50";
            } else if (isCorrectOption) {
              buttonClass += "border-green-500 bg-green-50";
            } else {
              buttonClass += "border-gray-200 bg-gray-50";
            }

            return (
              <button
                key={idx}
                onClick={() => !showResult && handleAnswerSelect(idx)}
                disabled={showResult}
                className={buttonClass}
              >
                <div className="flex items-center justify-between">
                  <span className="font-medium">{option}</span>
                  {showResult && isSelected && isCorrect && (
                    <CheckCircle className="w-5 h-5 text-green-600" />
                  )}
                  {showResult && isSelected && !isCorrect && (
                    <XCircle className="w-5 h-5 text-red-600" />
                  )}
                  {showResult && !isSelected && isCorrectOption && (
                    <CheckCircle className="w-5 h-5 text-green-600" />
                  )}
                </div>
              </button>
            );
          })}
        </div>

        {showResult && (
          <div className={`p-4 rounded-lg mb-6 ${isCorrect ? 'bg-green-50 border border-green-200' : 'bg-blue-50 border border-blue-200'}`}>
            <p className={`font-semibold mb-2 ${isCorrect ? 'text-green-700' : 'text-blue-700'}`}>
              {isCorrect ? 'âœ“ Correct!' : 'Explanation:'}
            </p>
            <p className="text-gray-700">{question.explanation}</p>
          </div>
        )}

        {showResult && (
          <Button
            onClick={handleNextQuestion}
            className="w-full bg-gradient-to-r from-blue-500 to-cyan-500"
          >
            {currentQuestion < existingQuiz.questions.length - 1 ? 'Next Question' : 'Complete Quiz'}
          </Button>
        )}
      </CardContent>
    </Card>
  );
}