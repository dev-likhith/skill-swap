import React, { useState } from "react";
import { base44 } from "@/api/base44Client";
import { useQuery, useMutation, useQueryClient } from "@tanstack/react-query";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Textarea } from "@/components/ui/textarea";
import { MessageCircle, Send, Clock, AlertCircle } from "lucide-react";
import { Badge } from "@/components/ui/badge";
import { Alert, AlertDescription } from "@/components/ui/alert";
import { format, differenceInHours } from "date-fns";

export default function DoubtSupportSection({ purchase }) {
  const queryClient = useQueryClient();
  const [newMessage, setNewMessage] = useState("");

  const { data: user } = useQuery({
    queryKey: ['currentUser'],
    queryFn: () => base44.auth.me(),
  });

  const { data: messages, isLoading } = useQuery({
    queryKey: ['doubtMessages', purchase.id],
    queryFn: () => base44.entities.DoubtMessage.filter({ purchase_id: purchase.id }, 'created_date'),
    initialData: [],
  });

  const sendMessage = useMutation({
    mutationFn: async (messageText) => {
      return await base44.entities.DoubtMessage.create({
        purchase_id: purchase.id,
        video_id: purchase.video_id,
        sender_id: user.id,
        sender_name: user.full_name,
        sender_role: 'learner',
        message: messageText,
      });
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['doubtMessages'] });
      setNewMessage("");
    },
  });

  const handleSendMessage = () => {
    if (newMessage.trim()) {
      sendMessage.mutate(newMessage);
    }
  };

  // Check if support has expired
  const supportExpiry = new Date(purchase.support_expiry);
  const now = new Date();
  const hoursRemaining = differenceInHours(supportExpiry, now);
  const isExpired = hoursRemaining <= 0;

  return (
    <Card className="border-pink-200 shadow-lg">
      <CardHeader className="bg-gradient-to-r from-pink-50 to-rose-50">
        <div className="flex items-center justify-between">
          <CardTitle className="flex items-center gap-2 text-lg">
            <MessageCircle className="w-5 h-5 text-pink-500" />
            Doubt Support
          </CardTitle>
          <Badge variant={isExpired ? "destructive" : "secondary"} className="flex items-center gap-1">
            <Clock className="w-3 h-3" />
            {isExpired ? 'Expired' : `${hoursRemaining}h left`}
          </Badge>
        </div>
      </CardHeader>
      <CardContent className="pt-6">
        {isExpired && (
          <Alert variant="destructive" className="mb-4">
            <AlertCircle className="w-4 h-4" />
            <AlertDescription>
              Your 48-hour support period has expired. You can no longer send messages.
            </AlertDescription>
          </Alert>
        )}

        <div className="space-y-4 mb-4 max-h-96 overflow-y-auto">
          {messages.length === 0 ? (
            <p className="text-center text-gray-500 py-8">
              No messages yet. Ask your first question!
            </p>
          ) : (
            messages.map((message) => (
              <div
                key={message.id}
                className={`p-4 rounded-lg ${
                  message.sender_role === 'learner'
                    ? 'bg-blue-50 ml-4'
                    : 'bg-green-50 mr-4'
                }`}
              >
                <div className="flex items-center justify-between mb-2">
                  <span className="font-semibold text-sm">{message.sender_name}</span>
                  <span className="text-xs text-gray-500">
                    {format(new Date(message.created_date), 'MMM d, HH:mm')}
                  </span>
                </div>
                <p className="text-gray-700 text-sm">{message.message}</p>
              </div>
            ))
          )}
        </div>

        {!isExpired && (
          <div className="space-y-3">
            <Textarea
              placeholder="Ask your doubt or question..."
              value={newMessage}
              onChange={(e) => setNewMessage(e.target.value)}
              rows={3}
              className="resize-none"
            />
            <Button
              onClick={handleSendMessage}
              disabled={!newMessage.trim() || sendMessage.isPending}
              className="w-full bg-gradient-to-r from-pink-500 to-rose-500"
            >
              <Send className="w-4 h-4 mr-2" />
              {sendMessage.isPending ? 'Sending...' : 'Send Message'}
            </Button>
          </div>
        )}
      </CardContent>
    </Card>
  );
}